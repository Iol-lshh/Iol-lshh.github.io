{"componentChunkName":"component---src-templates-blog-post-js","path":"/pattern/websocket/websocket_정리/","result":{"data":{"site":{"siteMetadata":{"title":"Iol-lshh's","siteUrl":"https://iol-lshh.github.io"}},"markdownRemark":{"id":"47c24199-5629-5321-8456-562e0c73b719","excerpt":"웹 소켓 구현은 꽤나 챌린지가 필요한 부분이다. 구현하고 나서도 오래되면 까먹기도 하고, 헷갈리기 쉽다. 그래서 웹 소켓을 구현하기 위해 알아야 할 것들에 대해 정리해보고, 분산 환경에서 웹소켓은 어떻게 구현해야 하는지에 대해 정리했다. WebSocket WebSocket…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/683918bd96939f2b9a5b248025950bb8/437a1/header.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACfklEQVR42mVSaU8TURSdP2NMw9IgIahtlEKH0mlnWsgARYKkRQmLNuJHlfDFoNakImXrVOgynU63aTpLZ6FLKBINYmKMmhDjB/Wrf8I7tCVEk5OXl5t33rn33IPgkuoUG1BaUP8BJlfMmeLNBGtKZlFRwyWtUUfw1gu8tO8AJvxV0pxCqyiqdklz0Uy8lD56X9LqxQU6ihYk4oyP6MqS6uDlwThDpDL2OGPLcHpRUJyCDI+sbD4rJH6eCKcn0ukH8VONnWKYIWkfFxUE+gTNQTpFhsPe2sFkisWoNxjQlDIua4RWRTNcuZo7rmUPVKamJL/Ws7NpBtWb0skqJihEJu9hM2SOI2lmjCuaX61bqN2+Laqf2jVT0YnQ2o8vlT+/jn9/f/u8wKAcT8BoOllQcLmMRqK+o3fEXsxbPyKSrI3NO4oSVhRt6bw1xtzYCA8tL9uCa+ZA0ETFMI5vWIucWaVPb6fZ4SyHw9i5gqtyAEa4qvUr/ofto56eucWu2YWuu3O9i/5u70zHtA9XyuAIQiiVgb1Ez5OVq6svuh+vXH8ZNAWC11YD1njSVTvsvr/U//QZthMZeB2yblNj5Zr3+GPXnTl9KaAMS7Pnipbwbt92xBKJ9keicOnbiUDDoAxkbGPLGaNn1kMPQuuP0qwvle6cnT9vG9zWCLUKxupnA1oV6m5Q9i95eMn3+Vsgn6P5QiydXNzc7FjwE3K5OXMzWMIF8DJUML5kID2d5Hjv/D3jba9x2me8NdU+MnrZ6RpMZUESuRBD5cJHMi7vo4lUx+R02/CYwU1ecroBhpHxdtLTNjph2aYItYL8n+TzkMPfDgifKDdjq9+VBs4WpPwF8jqi7DfCNscAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/683918bd96939f2b9a5b248025950bb8/dc87c/header.avif 158w,\n/static/683918bd96939f2b9a5b248025950bb8/383b4/header.avif 315w,\n/static/683918bd96939f2b9a5b248025950bb8/d0061/header.avif 630w,\n/static/683918bd96939f2b9a5b248025950bb8/20e2c/header.avif 945w,\n/static/683918bd96939f2b9a5b248025950bb8/9eba6/header.avif 1260w,\n/static/683918bd96939f2b9a5b248025950bb8/c68af/header.avif 1536w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/683918bd96939f2b9a5b248025950bb8/5787a/header.webp 158w,\n/static/683918bd96939f2b9a5b248025950bb8/89f54/header.webp 315w,\n/static/683918bd96939f2b9a5b248025950bb8/4d353/header.webp 630w,\n/static/683918bd96939f2b9a5b248025950bb8/0f41d/header.webp 945w,\n/static/683918bd96939f2b9a5b248025950bb8/f27a3/header.webp 1260w,\n/static/683918bd96939f2b9a5b248025950bb8/a8642/header.webp 1536w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/683918bd96939f2b9a5b248025950bb8/dda05/header.png 158w,\n/static/683918bd96939f2b9a5b248025950bb8/679a3/header.png 315w,\n/static/683918bd96939f2b9a5b248025950bb8/50637/header.png 630w,\n/static/683918bd96939f2b9a5b248025950bb8/fddb0/header.png 945w,\n/static/683918bd96939f2b9a5b248025950bb8/f46b1/header.png 1260w,\n/static/683918bd96939f2b9a5b248025950bb8/437a1/header.png 1536w\"\n            sizes=\"(max-width: 630px) 100vw, 630px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/683918bd96939f2b9a5b248025950bb8/50637/header.png\"\n            alt=\"header\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>웹 소켓 구현은 꽤나 챌린지가 필요한 부분이다. 구현하고 나서도 오래되면 까먹기도 하고, 헷갈리기 쉽다. 그래서 웹 소켓을 구현하기 위해 알아야 할 것들에 대해 정리해보고, 분산 환경에서 웹소켓은 어떻게 구현해야 하는지에 대해 정리했다.</p>\n<h2>WebSocket</h2>\n<p>WebSocket은 내부적으로 TCP 소켓을 사용한다. 클라이언트가 WebSocket 연결을 맺으면 <strong>서버는 새로운 소켓 하나를 열고, 이 소켓에 파일디스크립터를 하나 할당한다.</strong></p>\n<ul>\n<li><strong>파일 디스크립터(File Descriptor, FD)</strong>: 운영체제가 열려 있는 \"파일, 소켓, 파이프 등 리소스\"를 식별하기 위해 부여하는 번호(ID). FD는 커널 공간에서 관리된다.</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>메모리 영역</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>사용자 공간(User Space)</td>\n<td>일반 애플리케이션이 사용하는 공간</td>\n</tr>\n<tr>\n<td>커널 공간(Kernel Space)</td>\n<td>운영체제가 사용하는 특권 메모리 공간</td>\n</tr>\n</tbody>\n</table>\n<p>FD가 사용되는 곳을 살펴보면 다음과 같다.</p>\n<table>\n<thead>\n<tr>\n<th>리소스 종류</th>\n<th>예시</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>일반 파일</td>\n<td>로그 파일, 설정 파일, 데이터 파일 등</td>\n</tr>\n<tr>\n<td>디렉토리</td>\n<td><code class=\"language-text\">/etc/</code>, <code class=\"language-text\">/usr/local/bin</code> 등</td>\n</tr>\n<tr>\n<td>소켓(Socket)</td>\n<td><strong>TCP 연결</strong> (예: WebSocket, HTTP)</td>\n</tr>\n<tr>\n<td>파이프(pipe)</td>\n<td>프로세스 간 통신</td>\n</tr>\n<tr>\n<td>터미널</td>\n<td>stdin, stdout, stderr</td>\n</tr>\n</tbody>\n</table>\n<p>TCP하면 HTTP를 빼놓을 수 없다.</p>\n<ul>\n<li><strong>HTTP</strong>: 기본적으로 Stateless(무상태) 프로토콜</li>\n</ul>\n<p>HTTP로 제공되는 서비스는 클라이언트 상태에 대해 연속성을 요구하기도 한다. 그것을 세션이라고 한다.</p>\n<ul>\n<li><strong>세션</strong>(Session): 클라이언트와 서버 간의 상태를 유지하기 위한 서버 측 저장 공간</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>개념</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>세션 ID</td>\n<td>클라이언트를 구분하기 위한 고유 키</td>\n</tr>\n<tr>\n<td>세션 스토리지</td>\n<td>서버가 세션 ID에 대응되는 데이터를 저장하는 공간</td>\n</tr>\n<tr>\n<td>클라이언트 상태 저장</td>\n<td>로그인 여부, 장바구니, 임시 정보 등 저장 가능</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p>HTTP 세션과 웹소켓은 비슷하면서도 다르다. 스프링의 <code class=\"language-text\">WebSocketSession</code>, <code class=\"language-text\">HttpSession</code> 두 개의 세부 구현의 비교를 통해, 웹소켓의 동작 방식에 대해 이해해보자.</p>\n<h2><code class=\"language-text\">WebSocketSession</code> vs <code class=\"language-text\">HttpSession</code></h2>\n<p>두 가지 모두 상태를 유지한다는 점에서 동일하다. 하지만 실제 동작에는 차이가 있다. HTTP 세션은 상태를 유지할 뿐이다. 웹소켓 세션은 상태를 유지할 뿐만 아니라, 논리적 연결을 유지하기까지 한다.</p>\n<h3><code class=\"language-text\">HttpSession</code></h3>\n<p>HTTP 요청 기반으로 동작. 요청(request)마다 세션 ID가 쿠키(JSESSIONID 등)를 통해 전달되고, 세션 저장소에서 데이터를 읽고 쓰며, 기본적으로는 서버에 캐시처럼 보관한다.</p>\n<p>HTTP는 <strong>무상태(stateless)</strong> 프로토콜이기 때문에 클라이언트와 서버 간의 연결 상태를 유지하지 않는다. 요청이 들어오면 다음과 같이 동작된다.</p>\n<ul>\n<li>HttpSession 객체를 서버 측 세션 저장소에 유지하며, 클라이언트가 요청할 때 전달된 세션 ID(<code class=\"language-text\">JSESSIONID</code>)를 통해 해당 세션 객체를 로드할 수 있다.</li>\n<li>HttpSession은 특정 요청(request)이 들어왔을 때만 스레드에 연결한다.</li>\n<li>요청 처리가 끝나면 HttpSession은 더 이상 스레드에 연결되지 않고, 세션 저장소에 다시 캐싱(보관)된 상태로 유지한다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d3e18752b040ed9c93f405fd2d8e7b65/40a26/%EC%84%B8%EC%85%98.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 153.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAYAAADnTu3OAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQ0lEQVR42p2Vh27DMAxE/f9flwTZe++9N4vHgoGryisCDNuUdCKPRyp4Pp9yOp3kfD7r+3q96vflctEH2+PxUJvZbU143e12E0ZwPB4ln89LvV6XarUqw+FQ2u229Ho9/S8WizKfz6VSqUihUNA386znm3XYJ5PJL+D7/Rb3YbxeL8F7xna7VS+Yw8acPWazfYHEDFvU7/c19DTDC8jJUGG81mo1Wa1Watvtdh++UgOyodlsymAwUDC+G42GvuF0s9n8iSAR0OUTr8hseC6Thy6HZPVwOER6lRrQxmg00ix/nZSo8JO8SwSkQtAgGUbcpsWvANmIfLrdrnQ6Ha0KCztzUmwDnll2AV8ul+r1Vx4uFgsNF/D7/a7lhYfULP+pAfFkOp1+ZOIOwMbjsb4Thc0CqmG/33u5sn8OQ5vWYWI9zOVy3pPNZu9yuayUuAcHkIxwOY2uQkZns5k+hGYtjHX0Pvolc9Q283DNfmhSQDawAEOr1dKQAWYRdhcQEA6nwXI4azkEnXpDXq/X/9qTWyUmITvsH4fhDXiC/jjV5QhN4iXe0Ct9nSmIIh+OSqWSAhMaYfKmP8ZVTGSl4AV8GmeQbwmLq5bIK8BavtvJAbT7xS6p8BP4wkXY4TYf5ogK4RoAzBeZF5CWjxdUBGGTUZKBVKgQu1+wIS94RnLsiwS0Ww/+8NiEDre0NOMVmaEGdIwTXkDAWOzaGWQYfjO3L05FImGRE264HDM3WGRiJQZHNIQ4sMQ7haTADeHDHZlPulN+AN+sb1UaWdRtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d3e18752b040ed9c93f405fd2d8e7b65/dc87c/%EC%84%B8%EC%85%98.avif 158w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/383b4/%EC%84%B8%EC%85%98.avif 315w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/d0061/%EC%84%B8%EC%85%98.avif 630w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/927d0/%EC%84%B8%EC%85%98.avif 874w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/d3e18752b040ed9c93f405fd2d8e7b65/5787a/%EC%84%B8%EC%85%98.webp 158w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/89f54/%EC%84%B8%EC%85%98.webp 315w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/4d353/%EC%84%B8%EC%85%98.webp 630w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/60d6a/%EC%84%B8%EC%85%98.webp 874w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d3e18752b040ed9c93f405fd2d8e7b65/dda05/%EC%84%B8%EC%85%98.png 158w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/679a3/%EC%84%B8%EC%85%98.png 315w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/50637/%EC%84%B8%EC%85%98.png 630w,\n/static/d3e18752b040ed9c93f405fd2d8e7b65/40a26/%EC%84%B8%EC%85%98.png 874w\"\n            sizes=\"(max-width: 630px) 100vw, 630px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d3e18752b040ed9c93f405fd2d8e7b65/50637/%EC%84%B8%EC%85%98.png\"\n            alt=\"  \"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3><code class=\"language-text\">WebSocketSession</code></h3>\n<p>WebSocket은 HTTP 프로토콜과는 별개로 동작하며, TCP 커넥션 기반으로 <strong>논리적 연결</strong>을 유지한다. WebSocket은 HTTP 프로토콜을 통해 초기 핸드쉐이크를 수행한 후, TCP 기반의 양방향 통신으로 전환된다.</p>\n<p>스프링의 <code class=\"language-text\">WebSocketSession</code>은, 연결된 동안 서버와 클라이언트가 지속적으로 <strong>논리적 연결</strong>이 유지된다. 다만, 이 연결은 스레드를 계속 점유하진 않는다. TCP 소켓(FD)만 유지된 채, 스레드를 반환한다. (플럭스도 비슷하다.)</p>\n<p>Spring WebSocket은 연결된 소켓에 메시지가 도착하면, 컨테이너에서 관리하는 스레드 풀에서 사용 가능한 스레드를 할당해 메시지를 처리한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b19f6e2e0e83757d2b3e21629f6a2294/3690d/%EC%9B%B9%EC%86%8C%EC%BC%93.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.9873417721519%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZ0lEQVR42oWTia6CQAxF5/9/T4K4IqJoVFTQiAvYl9OkZKLgm6TpdLrk3rbjxDt1Xcv9fle53W7yeDxawX4+n1JVlfpNN03jlxDnG2VZShRFkiSJDAYDGY1GMhwO1Q6CQHa7ncRxrPZ0OtU7Rb8Kvt/vVkBp8nq9FMHpdFJ0+LHxmfZzvxB+HgsCEej9t77jCADB8XiUoijkfD5Lnuey3+/lcrmoTUHocicOIYY83tDktgVJoFfz+VyF3kwmEy1iPTwcDrJarfSOjMdjjUnTVGWz2XRT9nti9EDDpPv8fhvc54N/t5UAMbR+9bBzKExtu93KcrlUelBer9dKD5rczQdFdCdCHxFFSCKBvqEplmWZCkV5Q7B7Kfs9+aRBYevhf8f1FbIl5jB5BmMsfgFw7A/fjaTFYqF0rW8MYzabtT5o2mrZ6vA98YVhqLvooMISgwBqLK0tNAEI9vV6VeHH8Ia2pcaPptYfjfU2hzmvC+cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b19f6e2e0e83757d2b3e21629f6a2294/dc87c/%EC%9B%B9%EC%86%8C%EC%BC%93.avif 158w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/383b4/%EC%9B%B9%EC%86%8C%EC%BC%93.avif 315w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/d0061/%EC%9B%B9%EC%86%8C%EC%BC%93.avif 630w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/60e96/%EC%9B%B9%EC%86%8C%EC%BC%93.avif 920w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/b19f6e2e0e83757d2b3e21629f6a2294/5787a/%EC%9B%B9%EC%86%8C%EC%BC%93.webp 158w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/89f54/%EC%9B%B9%EC%86%8C%EC%BC%93.webp 315w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/4d353/%EC%9B%B9%EC%86%8C%EC%BC%93.webp 630w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/32366/%EC%9B%B9%EC%86%8C%EC%BC%93.webp 920w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b19f6e2e0e83757d2b3e21629f6a2294/dda05/%EC%9B%B9%EC%86%8C%EC%BC%93.png 158w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/679a3/%EC%9B%B9%EC%86%8C%EC%BC%93.png 315w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/50637/%EC%9B%B9%EC%86%8C%EC%BC%93.png 630w,\n/static/b19f6e2e0e83757d2b3e21629f6a2294/3690d/%EC%9B%B9%EC%86%8C%EC%BC%93.png 920w\"\n            sizes=\"(max-width: 630px) 100vw, 630px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b19f6e2e0e83757d2b3e21629f6a2294/50637/%EC%9B%B9%EC%86%8C%EC%BC%93.png\"\n            alt=\"   \"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th>유지 방법</th>\n<th>자원 소모</th>\n<th>풀 사용 여부</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>WebSocket 연결 (TCP)</td>\n<td>클라이언트별 유지</td>\n<td>파일 디스크립터(FD), 메모리 (소량)</td>\n<td>별도 풀 없음</td>\n</tr>\n<tr>\n<td>작업 스레드</td>\n<td>요청 시에만 풀에서 할당</td>\n<td>CPU, 메모리 (작업 처리에 따라 다름)</td>\n<td>스레드 풀 사용</td>\n</tr>\n<tr>\n<td>커넥션 풀</td>\n<td>재사용 목적의 연결 관리</td>\n<td>DB, HTTP 클라이언트에서 사용</td>\n<td>WebSocket과 무관</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p>HTTP 세션을 분산환경에서 구현하는 방법에 대해 기억해보면, 레디스를 도입하거나 별도 서비스를 구현하거나 해야한다. <strong>서버 간 상태 동기화</strong>가 필요한 것이다.</p>\n<p>HttpSession은 서버 인스턴스(톰캣 등)에 종속된다. 때문에 Sticky Session이 필요하다.</p>\n<ul>\n<li><strong>Sticky Session</strong>(Session Affinity): 클라이언트의 모든 요청을 항상 동일한 서버 인스턴스로 보내도록 로드밸런서가 고정시키는 전략</li>\n</ul>\n<p>하지만 여기서 본래 HttpSession을 대신하여 \"<strong>클라이언트의 상태를 유지하면서, 서버 간 상태를 동기화한다</strong>\"라는 본래 의도에 집중하면 다음처럼 구현이 가능하다.</p>\n<ul>\n<li><strong>중앙 세션 저장소</strong> (Centralized Session Store): 세션 정보를 Redis 같은 외부 저장소에 저장해서, 모든 서버가 세션을 공유</li>\n<li><strong>토큰 기반 인증</strong> (Token-Based Authentication) + Stateless 세션: 세션을 서버에 저장하지 않고, <strong>사용자에게 상태를 담은 토큰(JWT 등)을 발급</strong>해서 클라이언트가 들고 다님</li>\n</ul>\n<p>이런 구현은 일부 서버가 정지되더라도 클라이언트 상태가 전체 시스템 상에서 유지되도록 한다.</p>\n<p>하지만 웹 소켓은 이런 방법들과 유사하면서도 다르게 해결해야한다. 웹 소켓은 서버 인스턴스에서 클라이언트와 연결을 유지하고 있는데, 그것의 본질은 TCP 소켓이고, FD이다. 이것은 서버의 커널 공간에서 관리되기 때문이다.</p>\n<h2>분산 환경에서의 WebSocket</h2>\n<p>웹 소켓을 분산환경에서 사용하기 위해선 웹소켓 세션이 만들어진 서버를 찾아가야 한다. 이를 위한 방안은 크게 세 가지가 있다.</p>\n<ul>\n<li>세션 고정 (Sticky Session)</li>\n<li>세션 정보 공유</li>\n<li>메세지 브로커 사용</li>\n</ul>\n<h3>세션 고정</h3>\n<p>LB나 WebSocket Gateway / Message Router 같은 API Gateway를 이용한다. 요청 시점에 웹 소켓 세션이 있는 서버로 라우팅하는 것이다.</p>\n<h3>세션 정보 공유</h3>\n<p>단순히 세션 정보를 제공한다. 세션 정보는 세션이 붙어있는 서버 정보를 보여준다. 이때 세션 정보 테이블을 각 서버가 실시간으로 공유해야 한다. 그 방법이 영속성을 조회한다던지(레디스든 디비든), 서비스로 운영한다던지, 어떤 방법이든 상관 없다.</p>\n<h3>메세지 브로커 사용</h3>\n<p>메시지를 분산 서비스가 볼 수 있는 곳으로 발행한다. 발행된 메시지는 모든 서버가 바라보고 있으며, 메시지가 자신이 관리하는 세션이라면, 이를 받아와 WebSocketSession을 이용해 스레드가 일하게 하고 메시지를 발송하게 된다.</p>\n<p>(카프카를 메시지 브로커로 활용하더라도 카프카는 유량 조절과 비동기적 실시간 전달에 유리하므로 활용하고, 데이터 자체는 디비에 넣도록 한다.)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ecd86d94e21e37f9543d9c01b56e7b09/40a26/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.78481012658227%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXElEQVR42q2U266CMBBF+f9/M1FQURTF+IAhEJ68C3OyJtmk8ZaTk9Nk6JRpp5vVKZEF7Xq92vF4tNPp9GLn89lut5tdLhf3MeY/t4hH3/c+2O/3NplMbLFY2Gq1svV67bZcLn1cVZWP8TebjR0Oh/cJ1bquc3s8Hr4Jhqq2bd2/3+8eU5y5XxO+ayTZbrf22zYkZEd2JgGGMnqYZVk2MMOIYfjC9ZKQxXme++KyLJ1bHMc2nU7dh61YMi9JEp+LiI8KtXOoFGVN0wxsFdMXfFT4jWFRFH9jKIU6TVTBiTLSe/rnanibEPhpmjofag1/NBo5O1iRVHH4wZOeixDWchTWoFRgKNOtqOva1YQnrxN/rsV/YzgoFCudoIx3uh18ssZaGM5ljuLRbrcb7iYL8WEzn8/dH4/HNpvNvB6pS5gSg6FqFK7E4BmJl044vAWY/iwY7MI/T1gVxFD5A5y6h9glF+nNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ecd86d94e21e37f9543d9c01b56e7b09/dc87c/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.avif 158w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/383b4/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.avif 315w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/d0061/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.avif 630w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/927d0/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.avif 874w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/avif\"\n            /><source\n              srcset=\"/static/ecd86d94e21e37f9543d9c01b56e7b09/5787a/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.webp 158w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/89f54/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.webp 315w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/4d353/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.webp 630w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/60d6a/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.webp 874w\"\n              sizes=\"(max-width: 630px) 100vw, 630px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ecd86d94e21e37f9543d9c01b56e7b09/dda05/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.png 158w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/679a3/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.png 315w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/50637/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.png 630w,\n/static/ecd86d94e21e37f9543d9c01b56e7b09/40a26/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.png 874w\"\n            sizes=\"(max-width: 630px) 100vw, 630px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ecd86d94e21e37f9543d9c01b56e7b09/50637/%EB%B6%84%EC%82%B0%EC%9B%B9%EC%86%8C%EC%BC%93%EC%84%B8%EC%85%98.png\"\n            alt=\"       \"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>세가지 방안 모두 결론적으로, 웹소켓 세션이 만들어진 서버를 찾아가야 한다. 다만, 실제 구현에서는 찾아가는 부담을 줄여야하며, 아예 없어보이는 방향으로 설계하는 것이 바람직할 것이다.</p>\n<p>참고로, 서버가 죽거나 어쨌든 웹소켓이 끊긴 것을 클라이언트가 알게 된다면, 클라이언트에서 다시 웹소켓을 연결해야한다. WebSocketSession은 복원 불가해도, 사용자 상태는 복원 가능하니깐 문제없다. 물론 재연결 후 사용자 경험을 이어가기 위해서는 추가 설계가 필요할 것이다.</p>\n<p>추가적으로 여기에 이벤트 소싱을 같이 생각해 볼 수도 있겠다. (채팅 서비스라던지..?)</p>\n<hr>\n<h2>❗️FD 이슈</h2>\n<p>TCP 소켓은 FD를 할당받는다. 웹소켓은 유지된다. 만약 하나의 서버에 웹소켓으로 구현된 채팅이 어마어마한 수가 연결되고 유지된다면 어떻게 할까?</p>\n<ul>\n<li>각 WebSocket 연결 = 하나의 TCP 소켓 = 하나의 FD 소모</li>\n<li>예를 들어, 1만 명의 유저가 접속하면 <strong>최소 1만 개의 FD가 소모</strong>됨</li>\n<li>여기에 로그 파일, 데이터베이스 연결 등도 FD를 추가로 차지</li>\n</ul>\n<p>FD가 꽉 차면</p>\n<ul>\n<li>새로운 클라이언트 연결을 수락할 수 없음 (→ WebSocket handshake 실패)</li>\n<li>파일이나 소켓을 열 수 없어서 서비스 전체에 장애 발생 가능</li>\n<li><code class=\"language-text\">java.io.IOException: Too many open files</code></li>\n</ul>\n<p>이를 해결하기 위한 방안은 다음과 같다.</p>\n<ul>\n<li>OS 레벨에서 FD 수 늘린다.</li>\n<li>한 서버에 모든 연결을 몰지 않고, <strong>서버 인스턴스를 여러 대로 분산</strong>하여 각 서버가 일부만 처리하게 한다.</li>\n<li>웹소켓의 커넥션 유지 시간 조절, 타임아웃 적용한다.</li>\n<li>FD 모니터링도 추가하면 좋다.</li>\n</ul>","images":null,"frontmatter":{"title":"웹소켓 정리","date":"April 08, 2025","description":"스프링 부트에서 웹소켓으로 채팅 구현하기","category":["pattern"],"featuredImage":null}},"previous":{"fields":{"slug":"/translation/martinfowler/Continuous_Integration/Continuous_Integration/"},"frontmatter":{"title":"Continuous Integration 번역","category":["번역","pattern","cicd"]}},"next":{"fields":{"slug":"/pattern/synchronization/synchronization_정리/"},"frontmatter":{"title":"Synchronization 정리","category":["pattern"]}}},"pageContext":{"id":"47c24199-5629-5321-8456-562e0c73b719","previousPostId":"77160d30-847a-5043-9e34-49e93341306a","nextPostId":"6566f64d-c024-5949-ac31-39d0f0645f8c"}},"staticQueryHashes":["1408108323","3764592887","62622001"],"slicesMap":{}}